<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° IT (External)</title>
    <style>
      body {
        font-family: "Sarabun", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f4f4fb;
        margin: 0;
        padding: 24px;
      }
      .page {
        max-width: 880px;
        margin: 0 auto;
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        padding: 20px 24px;
        margin-bottom: 16px;
      }
      .header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .sub {
        font-size: 13px;
        color: #666;
      }
      .row {
        display: flex;
        gap: 12px;
        margin: 4px 0;
        font-size: 14px;
      }
      .row-label {
        width: 140px;
        color: #555;
      }
      .row-value {
        flex: 1;
        font-weight: 500;
      }
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }
      .badge-pending  { background: #e0f2fe; color: #1d4ed8; }
      .badge-approved { background: #dcfce7; color: #166534; }
      .badge-rejected { background: #fee2e2; color: #b91c1c; }

      /* ‚ùó ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö width/height ‡∏Ç‡∏≠‡∏á canvas */
      canvas {
        border: 2px dashed #d4d4d8;
        border-radius: 8px;
        width: 300px;   /* ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö attribute width */
        height: 120px;  /* ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö attribute height */
        background: #fff;
        margin: 10px 0 8px;
        touch-action: none; /* ‡∏Å‡∏±‡∏ô browser scroll ‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å‡∏ô‡∏¥‡πâ‡∏ß */
      }

      .btn {
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        font-family: inherit;
      }
      .btn-primary {
        background: linear-gradient(135deg,#6366f1,#7c3aed);
        color: #fff;
      }
      .btn-primary:disabled {
        background: #c4c4d8;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: #fff;
        border: 1px solid #d4d4d8;
        color: #4b5563;
      }
      .actions {
        display: flex;
        justify-content: flex-start;
        gap: 8px;
        margin-top: 12px;
      }
      textarea {
        width: 100%;
        min-height: 80px;
        border-radius: 8px;
        border: 1px solid #d4d4d8;
        padding: 8px 10px;
        font-family: inherit;
        font-size: 13px;
      }
      .status {
        margin-top: 10px;
        font-size: 13px;
        padding: 10px;
        border-radius: 8px;
        display: none;
      }
      .status-info    { background:#eff6ff; color:#1d4ed8; }
      .status-success { background:#dcfce7; color:#166534; }
      .status-error   { background:#fee2e2; color:#b91c1c; }

      .radio-group {
        display: flex;
        gap: 16px;
        margin-top: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ -->
      <div class="card">
        <div class="header">üìù ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° IT</div>
        <div class="sub" id="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠...</div>
      </div>

      <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
      <div class="card" id="requestCard" style="display:none;">
        <div class="row">
          <div class="row-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
          <div class="row-value" id="reqNo"></div>
        </div>
        <div class="row">
          <div class="row-label">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</div>
          <div class="row-value" id="reqName"></div>
        </div>
        <div class="row">
          <div class="row-label">‡πÅ‡∏ú‡∏ô‡∏Å</div>
          <div class="row-value" id="reqDept"></div>
        </div>
        <div class="row">
          <div class="row-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
          <div class="row-value" id="reqStatus"></div>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid #eee;">
        <div class="row">
          <div class="row-label">EMAIL</div>
          <div class="row-value" id="emploemail"></div>
        </div>
        <div class="row">
          <div class="row-label">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</div>
          <div class="row-value" id="forWork"></div>
        </div>
        <div class="row">
          <div class="row-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
          <div class="row-value" id="reason"></div>
        </div>
        <div class="row">
          <div class="row-label">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>
          <div class="row-value" id="items"></div>
        </div>
        <div class="row">
          <div class="row-label">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</div>
          <div class="row-value" id="programs"></div>
        </div>
        <div class="row">
          <div class="row-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
          <div class="row-value" id="budget"></div>
        </div>
      </div>

      <!-- ‡πÇ‡∏ã‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à + ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
      <div class="card" id="reviewCard" style="display:none;">
        <div class="header" style="font-size:16px;">‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
        <div class="radio-group">
          <label><input type="radio" name="reviewAction" value="Approved" checked> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
          <label><input type="radio" name="reviewAction" value="Rejected"> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
        </div>

        <div style="margin-top:12px;">
          <div style="font-size:14px; margin-bottom:4px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
          <textarea id="comment" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡πâ‡∏≤‡∏°‡∏µ"></textarea>
        </div>

        <div style="margin-top:16px;">
          <div style="font-size:14px; margin-bottom:4px;">‚úçÔ∏è ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</div>
          <!-- ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á canvas (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•) ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CSS -->
          <canvas id="signCanvas" width="300" height="120"></canvas>
          
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="button" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô</button>
          <button class="btn btn-secondary" type="button" id="clearSignBtn">‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
        </div>

        <div id="statusBox" class="status"></div>
      </div>
    </div>

    <script>
      // ====== CONFIG ======
      const WEB_APP_URL =
        'https://script.google.com/macros/s/AKfycbxe3OSwY-ko4E3qvVSyFQQ1W7OCZjufP-VmFT3LxPqFMwf_y8LO9A8cxFJjMvHvdj7ksQ/exec';

      let requestNo = '';
      let sessionId = '';
      let canvas, ctx, isDrawing = false, hasSignature = false;

      // ---------- helper status ----------
      function setStatus(msg, type) {
        const box = document.getElementById('statusBox');
        box.textContent = msg;
        box.style.display = 'block';
        box.className = 'status status-' + type;
      }

      // ---------- JSONP helper ----------
      function buildQuery(params) {
        return Object.keys(params)
          .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
          .join('&');
      }

      function jsonpRequest(action, params, callback) {
        const cbName = 'WF_JSONP_' + action + '_' + Date.now() + '_' + Math.floor(Math.random() * 1000);

        params = Object.assign({}, params, {
          action: action,
          callback: cbName
        });

        const script = document.createElement('script');
        script.src = WEB_APP_URL + '?' + buildQuery(params);

        let timeoutId;

        window[cbName] = function(res) {
          console.log('JSONP', action, 'result:', res);
          cleanup();
          callback && callback(res);
        };

        script.onerror = function() {
          console.error('JSONP', action, 'onerror');
          cleanup();
          callback && callback({ success: false, message: '‡πÇ‡∏´‡∏•‡∏î JSONP ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
        };

        function cleanup() {
          if (timeoutId) clearTimeout(timeoutId);
          if (script.parentNode) script.parentNode.removeChild(script);
          delete window[cbName];
        }

        timeoutId = setTimeout(function() {
          console.error('JSONP', action, 'timeout');
          cleanup();
          callback && callback({ success: false, message: 'timeout' });
        }, 15000);

        document.body.appendChild(script);
      }

      // ---------- canvas ----------
      function initCanvas() {
        canvas = document.getElementById('signCanvas');
        ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#111827';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseleave', stopDraw);

        canvas.addEventListener('touchstart', startDrawTouch, { passive: false });
        canvas.addEventListener('touchmove', drawTouch, { passive: false });
        canvas.addEventListener('touchend', stopDrawTouch, { passive: false });
      }

      // ‡πÄ‡∏°‡∏≤‡∏™‡πå: ‡πÉ‡∏ä‡πâ offsetX / offsetY ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞
      function startDraw(e) {
        e.preventDefault();
        isDrawing = true;
        hasSignature = true;
        const x = e.offsetX;
        const y = e.offsetY;
        ctx.beginPath();
        ctx.moveTo(x, y);
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const x = e.offsetX;
        const y = e.offsetY;
        ctx.lineTo(x, y);
        ctx.stroke();
      }

      function stopDraw(e) {
        if (e) e.preventDefault();
        isDrawing = false;
      }

      // ‡∏ó‡∏±‡∏ä: ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å clientX/clientY ‚Üí ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô canvas (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà scale)
      function getTouchPos(touch) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }

      function startDrawTouch(e) {
        e.preventDefault();
        const t = e.touches[0] || e.changedTouches[0];
        if (!t) return;
        const pos = getTouchPos(t);
        isDrawing = true;
        hasSignature = true;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }

      function drawTouch(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const t = e.touches[0] || e.changedTouches[0];
        if (!t) return;
        const pos = getTouchPos(t);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }

      function stopDrawTouch(e) {
        e.preventDefault();
        isDrawing = false;
      }

      function clearSignature() {
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
      }

      // ---------- load data from server ----------
      function loadRequest() {
        document.getElementById('subtitle').textContent =
          '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠ #' + requestNo + ' ...';

        jsonpRequest(
          'getWorkflowRequest',
          { requestNo: requestNo, session: sessionId },
          function(res) {
            if (!res || !res.success) {
              const msg = (res && res.message)
                ? res.message
                : ('res = ' + JSON.stringify(res));
              document.getElementById('subtitle').textContent =
                '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + msg;
              return;
            }

            const d = res.data || {};

            document.getElementById('requestCard').style.display = 'block';
            document.getElementById('reviewCard').style.display = 'block';

            document.getElementById('reqNo').textContent   = d.requestNo || '';
            document.getElementById('reqName').textContent = d.requesterName || '-';
            document.getElementById('reqDept').textContent = d.requesterDept || '-';

            const statusEl = document.getElementById('reqStatus');
            const st = (d.status || 'Pending Review');
            let cls = 'badge badge-pending';
            if (st === 'Approved') cls = 'badge badge-approved';
            else if (st.indexOf('Rejected') === 0) cls = 'badge badge-rejected';
            statusEl.innerHTML = '<span class="'+cls+'">'+st+'</span>';

            document.getElementById('forWork').textContent  = d.forWork     || '-';
            document.getElementById('reason').textContent   = d.reason      || '-';
            document.getElementById('items').textContent    = d.itemRequest || '-';
            document.getElementById('programs').textContent = d.programUse  || '-';
            document.getElementById('budget').textContent   = d.budget      || '-';

            document.getElementById('subtitle').textContent =
              '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠';
          }
        );
      }

      // ---------- submit review ----------
      function submitReview() {
        if (!hasSignature) {
          setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
          canvas.scrollIntoView({behavior: 'smooth', block: 'center'});
          return;
        }

        const actionEl = document.querySelector('input[name="reviewAction"]:checked');
        const action = actionEl ? actionEl.value : 'Approved';
        const comment = document.getElementById('comment').value || '';

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô...', 'info');

        const dataUrl = canvas.toDataURL('image/jpeg', 0.4);
        const base64  = dataUrl.split(',')[1] || dataUrl;
        console.log('signature dataUrl length =', dataUrl.length);
        console.log('signature base64 length  =', base64.length);

        const payload = {
          requestNo: requestNo,
          session:   sessionId,
          reviewAction: action,
          signature: base64,
          comment:   comment
        };

        jsonpRequest('saveReviewAction', payload, function(res) {
          console.log('JSONP saveReviewAction result:', res);
          if (!res || !res.success) {
            setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (res && res.message ? res.message : ''), 'error');
            btn.disabled = false;
            return;
          }
          setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö', 'success');
        });
      }

      // ---------- init ----------
      window.addEventListener('DOMContentLoaded', function() {
        console.log('Review page (external JSONP) DOMContentLoaded');
        initCanvas();
        document.getElementById('clearSignBtn').addEventListener('click', clearSignature);
        document.getElementById('submitBtn').addEventListener('click', submitReview);

        const params = new URLSearchParams(window.location.search);
        requestNo = params.get('requestNo') || '';
        sessionId = params.get('session') || '';

        console.log('query requestNo:', requestNo, 'session:', sessionId);

        if (!requestNo || !sessionId) {
          document.getElementById('subtitle').textContent =
            '‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ç‡∏≤‡∏î requestNo ‡∏´‡∏£‡∏∑‡∏≠ session)';
          return;
        }
        loadRequest();
      });
    </script>
  </body>
</html>
