<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>อนุมัติคำขอเพิ่ม IT (External)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --purple-pearl: #3D3B54;
        --purple-pearl-dark: #2F2D45;
        --gold-accent: #B8A068;
        --text-dark: #1A252F;
        --text-light: #5A6C7D;
        --text-light-on-navy: #D4D4D4;
      }

      body {
        font-family: "Sarabun", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #F5F5F5 0%, #EEEEEE 100%);
        margin: 0;
        padding: 24px;
        min-height: 100vh;
      }
      
      .page {
        max-width: 880px;
        margin: 0 auto;
      }
      
      .card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        padding: 20px 24px;
        margin-bottom: 16px;
        border-top: 4px solid transparent;
      }
      
      .card:first-child {
        border-top-color: var(--purple-pearl);
      }
      
      .card:nth-child(2),
      .card:nth-child(3) {
        border-top-color: var(--gold-accent);
      }
      
      .card:nth-child(4) {
        border-top-color: var(--purple-pearl);
      }
      
      .header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-dark);
        font-family: 'Playfair Display', serif;
        letter-spacing: 0.5px;
      }
      
      .sub {
        font-size: 13px;
        color: var(--text-light);
      }
      
      .row {
        display: flex;
        gap: 12px;
        margin: 4px 0;
        font-size: 14px;
      }
      
      .row-label {
        width: 180px;
        color: var(--text-light);
        font-weight: 500;
      }
      
      .row-value {
        flex: 1;
        font-weight: 500;
        color: var(--text-dark);
      }
      
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .badge-pending  { 
        background: #e0f2fe; 
        color: #1d4ed8; 
      }
      
      .badge-approved { 
        background: #dcfce7; 
        color: #166534; 
      }
      
      .badge-rejected { 
        background: #fee2e2; 
        color: #b91c1c; 
      }

      canvas {
        border: 2px dashed #d4d4d8;
        border-radius: 8px;
        width: 100%;
        background: #fff;
        margin: 10px 0 8px;
        touch-action: none;
        display: block;
      }

      .btn {
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, var(--purple-pearl), var(--purple-pearl-dark));
        color: #fff;
        box-shadow: 0 4px 12px rgba(61, 59, 84, 0.3);
      }
      
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(61, 59, 84, 0.4);
      }
      
      .btn-primary:disabled {
        background: #c4c4d8;
        cursor: not-allowed;
        box-shadow: none;
      }
      
      .btn-secondary {
        background: #fff;
        border: 1px solid #d4d4d8;
        color: var(--text-dark);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      
      .btn-secondary:hover {
        background: #f9f9f9;
        border-color: var(--purple-pearl);
        color: var(--purple-pearl);
      }
      
      .actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      
      textarea {
        width: 100%;
        min-height: 80px;
        border-radius: 8px;
        border: 1px solid #d4d4d8;
        padding: 8px 10px;
        font-family: inherit;
        font-size: 13px;
        color: var(--text-dark);
      }
      
      textarea:focus {
        outline: none;
        border-color: var(--purple-pearl);
        box-shadow: 0 0 0 2px rgba(61, 59, 84, 0.1);
      }
      
      .status {
        margin-top: 10px;
        font-size: 13px;
        padding: 10px;
        border-radius: 8px;
        display: none;
        font-weight: 500;
      }
      
      .status-info { 
        background: #eff6ff; 
        color: #1d4ed8;
        border-left: 4px solid #1d4ed8;
      }
      
      .status-success { 
        background: #dcfce7; 
        color: #166534;
        border-left: 4px solid #166534;
      }
      
      .status-error { 
        background: #fee2e2; 
        color: #b91c1c;
        border-left: 4px solid #b91c1c;
      }

      .radio-group {
        display: flex;
        gap: 16px;
        margin-top: 4px;
        font-size: 14px;
        color: var(--text-dark);
      }
      
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }
      
      .radio-group input[type="radio"] {
        cursor: pointer;
        accent-color: var(--purple-pearl);
      }
      
      hr {
        margin: 12px 0;
        border: none;
        border-top: 1px solid #eee;
      }
      
      @media (max-width: 768px) {
        body {
          padding: 16px;
        }
        
        .row {
          flex-direction: column;
        }
        
        .row-label {
          width: auto;
          margin-bottom: 2px;
        }
        
        .radio-group {
          flex-direction: column;
          gap: 8px;
        }
        
        .actions {
          flex-direction: column;
        }
        
        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <!-- หัวข้อ -->
      <div class="card">
        <div class="header">✅ อนุมัติคำขอเพิ่ม IT</div>
        <div class="sub" id="subtitle">กำลังโหลดรายละเอียดคำขอ...</div>
      </div>

      <!-- รายละเอียดคำขอหลัก -->
      <div class="card" id="requestCard" style="display:none;">
        <div class="row">
          <div class="row-label">เลขที่คำขอ</div>
          <div class="row-value" id="reqNo"></div>
        </div>
        <div class="row">
          <div class="row-label">ผู้แจ้ง</div>
          <div class="row-value" id="reqName"></div>
        </div>
        <div class="row">
          <div class="row-label">แผนก</div>
          <div class="row-value" id="reqDept"></div>
        </div>
        <div class="row">
          <div class="row-label">สถานะปัจจุบัน</div>
          <div class="row-value" id="reqStatus"></div>
        </div>
        <hr>
        <div class="row">
          <div class="row-label">EMAIL</div>
          <div class="row-value" id="emploemail"></div>
        </div>
        <div class="row">
          <div class="row-label">สำหรับใช้ในงาน</div>
          <div class="row-value" id="forWork"></div>
        </div>
        <div class="row">
          <div class="row-label">เหตุผลที่สั่งเพิ่ม</div>
          <div class="row-value" id="reason"></div>
        </div>
        <div class="row">
          <div class="row-label">อุปกรณ์</div>
          <div class="row-value" id="items"></div>
        </div>
        <div class="row">
          <div class="row-label">โปรแกรม</div>
          <div class="row-value" id="programs"></div>
        </div>
        <div class="row">
          <div class="row-label">งบประมาณ</div>
          <div class="row-value" id="budget"></div>
        </div>
        <div class="row">
          <div class="row-label">เครื่องเขียน</div>
          <div class="row-value" id="stationery"></div>
        </div>
        <div class="row">
          <div class="row-label">โทรศัพท์มือถือ</div>
          <div class="row-value" id="mobileNeed"></div>
        </div>
        <div class="row">
          <div class="row-label">เบอร์โทร (ถ้าต้องการ)</div>
          <div class="row-value" id="mobilePhone"></div>
        </div>
        <div class="row">
          <div class="row-label">นามบัตร</div>
          <div class="row-value" id="namecardType"></div>
        </div>
        <div class="row">
          <div class="row-label">การตั้งงบประมาณ</div>
          <div class="row-value" id="budgetOptions"></div>
        </div>
        <div class="row">
          <div class="row-label">กำหนดส่งมอบ</div>
          <div class="row-value" id="deliveryDate"></div>
        </div>
        <div class="row">
          <div class="row-label">Spec / Type / รุ่น / ยี่ห้อ</div>
          <div class="row-value" id="specDetail"></div>
        </div>
      </div>

      <!-- รายละเอียดคำตอบจากฟอร์มทั้งหมด -->
      <div class="card" id="allFormCard" style="display:none;">
        <div class="header" style="font-size:16px;">รายละเอียดคำตอบจากฟอร์ม (ทั้งหมด)</div>
        <div id="allFormFields"></div>
      </div>

      <!-- โซนการตัดสินใจ + ลายเซ็น -->
      <div class="card" id="reviewCard" style="display:none;">
        <div class="header" style="font-size:16px;">การอนุมัติและลงลายเซ็น</div>
        <div class="radio-group">
          <label><input type="radio" name="approveAction" value="Approved" checked> อนุมัติ</label>
          <label><input type="radio" name="approveAction" value="Rejected"> ไม่อนุมัติ</label>
        </div>

        <div style="margin-top:12px;">
          <div style="font-size:14px; margin-bottom:4px; color: var(--text-dark); font-weight: 500;">ความคิดเห็นเพิ่มเติม</div>
          <textarea id="comment" placeholder="ระบุหมายเหตุถ้ามี"></textarea>
        </div>

        <div style="margin-top:16px;">
          <div style="font-size:14px; margin-bottom:4px; color: var(--text-dark); font-weight: 500;">ลายเซ็นผู้อนุมัติ (จำเป็น)</div>
          <canvas id="signCanvas" width="600" height="200"></canvas>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="button" id="submitBtn">
            บันทึกผลการอนุมัติ
          </button>
          <button class="btn btn-secondary" type="button" id="clearSignBtn">
            ล้างลายเซ็น
          </button>
        </div>

        <div id="statusBox" class="status"></div>
      </div>
    </div>

    <script>
      // ====== CONFIG ======
      const WEB_APP_URL =
        'https://script.google.com/macros/s/AKfycbwAL1ISDOIC_0TVh4RZniHn34vP0O7x5yBHlyxGZ1-u8ctgEg9OtG9dNMAZwxH7sNww/exec';

      let requestNo = '';
      let sessionId = '';
      let canvas, ctx, isDrawing = false, hasSignature = false;

      // ---------- helper status ----------
      function setStatus(msg, type) {
        const box = document.getElementById('statusBox');
        box.textContent = msg;
        box.style.display = 'block';
        box.className = 'status status-' + type;
      }

      // ---------- JSONP helper ----------
      function buildQuery(params) {
        return Object.keys(params)
          .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k]))
          .join('&');
      }

      function jsonpRequest(action, params, callback) {
        const cbName = 'WF_JSONP_' + action + '_' + Date.now() + '_' + Math.floor(Math.random() * 1000);

        params = Object.assign({}, params, {
          action: action,
          callback: cbName
        });

        const script = document.createElement('script');
        script.src = WEB_APP_URL + '?' + buildQuery(params);

        let timeoutId;
        const timeoutMs = 30000; // ตอนนี้ใช้ JSONP แค่ getWorkflowRequest

        window[cbName] = function(res) {
          console.log('JSONP', action, 'result:', res);
          cleanup();
          callback && callback(res);
        };

        script.onerror = function() {
          console.error('JSONP', action, 'onerror');
          cleanup();
          callback && callback({ success: false, message: 'โหลด JSONP ไม่สำเร็จ' });
        };

        function cleanup() {
          if (timeoutId) clearTimeout(timeoutId);
          if (script.parentNode) script.parentNode.removeChild(script);
          delete window[cbName];
        }

        timeoutId = setTimeout(function() {
          console.error('JSONP', action, 'timeout');
          cleanup();
          callback && callback({ success: false, message: 'timeout' });
        }, timeoutMs);

        document.body.appendChild(script);
      }

      // ---------- canvas ----------
      function initCanvas() {
        canvas = document.getElementById('signCanvas');
        ctx = canvas.getContext('2d');

        // เติมพื้นหลังขาวกันโปร่งใส
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = '#111827';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';

        // mouse
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseleave', stopDraw);

        // touch
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDraw);
      }

      // scale ตำแหน่งเมาส์ตามขนาดจริงของ canvas
      function getCanvasPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width  / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (e.clientX - rect.left) * scaleX,
          y: (e.clientY - rect.top)  * scaleY
        };
      }

      function startDraw(e) {
        e.preventDefault();
        isDrawing = true;
        hasSignature = true;
        const pos = getCanvasPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getCanvasPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }

      function stopDraw(e) {
        if (!isDrawing) return;
        if (e) e.preventDefault();
        isDrawing = false;
      }

      function handleTouch(e) {
        const t = e.touches[0] || e.changedTouches[0];
        const mouseEventType =
          e.type === 'touchstart' ? 'mousedown' :
          e.type === 'touchmove'  ? 'mousemove' : 'mouseup';
        const ev = new MouseEvent(mouseEventType, {
          clientX: t.clientX,
          clientY: t.clientY
        });
        canvas.dispatchEvent(ev);
      }

      function clearSignature() {
        if (!ctx) return;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
      }

      // ---------- helper อ่านค่าจาก form object ----------
      function getFormValue(form, key, fallback) {
        if (form && form[key] !== undefined && form[key] !== '') {
          return form[key];
        }
        return (fallback !== undefined && fallback !== '') ? fallback : '-';
      }

      function formatDateOnly(value) {
        if (!value) return '-';

        const d = new Date(value);
        if (!isNaN(d.getTime())) {
          const yyyy = d.getFullYear();
          const mm   = String(d.getMonth() + 1).padStart(2, '0');
          const dd   = String(d.getDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        }
        return value;
      }

      // ---------- load data from server ----------
      function loadRequest() {
        document.getElementById('subtitle').textContent =
          'กำลังโหลดรายละเอียดคำขอ #' + requestNo + ' ...';

        jsonpRequest(
          'getWorkflowRequest',
          { requestNo: requestNo, session: sessionId },
          function(res) {
            if (!res || !res.success) {
              const msg = (res && res.message)
                ? res.message
                : ('res = ' + JSON.stringify(res));
              document.getElementById('subtitle').textContent =
                'ไม่สามารถโหลดข้อมูลได้: ' + msg;
              return;
            }

            const d    = res.data || {};
            const form = d.form || {};

            document.getElementById('requestCard').style.display = 'block';
            document.getElementById('reviewCard').style.display  = 'block';

            document.getElementById('reqNo').textContent   = d.requestNo || '';
            document.getElementById('reqName').textContent = d.requesterName || '-';
            document.getElementById('reqDept').textContent = d.requesterDept || '-';

            const statusEl = document.getElementById('reqStatus');
            const st = (d.status || 'Pending Approval');
            let cls = 'badge badge-pending';
            if (st === 'Approved') cls = 'badge badge-approved';
            else if (st.indexOf('Rejected') === 0) cls = 'badge badge-rejected';
            statusEl.innerHTML = '<span class="'+cls+'">'+st+'</span>';

            document.getElementById('emploemail').textContent =
              getFormValue(form, 'Email', d.emploemail);

            document.getElementById('forWork').textContent =
              getFormValue(form, 'สำหรับใช้ในงาน (โปรดระบุ)', d.forWork);

            document.getElementById('reason').textContent =
              getFormValue(form, 'เหตุผลที่สั่งเพิ่ม', d.reason);

            document.getElementById('items').textContent =
              getFormValue(form, 'ขอเพิ่มอุปกรณ์', d.itemRequest);

            document.getElementById('programs').textContent =
              getFormValue(form, 'โปรแกรมที่ใช้งาน', d.programUse);

            document.getElementById('budget').textContent =
              getFormValue(form, 'การตั้งงบประมาณ', d.budget);
            document.getElementById('stationery').textContent =
              getFormValue(form, 'เครื่องเขียน', d.stationery); 
            document.getElementById('mobileNeed').textContent =
              getFormValue(form, 'โทรศัพท์มือถือ', d.mobileNeed); 
            document.getElementById('mobilePhone').textContent =
              getFormValue(form, 'เครื่องเขียน', d.mobileNumber); 
            document.getElementById('namecardType').textContent =
              getFormValue(form, 'นามบัตร', d.nameCard); 
            document.getElementById('budgetOptions').textContent =
              getFormValue(form, 'การตั้งงบประมาณ', d.budgetType); 

            document.getElementById('deliveryDate').textContent =
              formatDateOnly(
              getFormValue(form, 'กำหนดส่งมอบ', d.deliveryDate) );

            document.getElementById('specDetail').textContent =
              getFormValue(form,'Spec. /Type. /รุ่น /ยี่ห้อ (ถ้ามีโปรดระบุ)', d.spec);
              
            // ======= แสดงทุกคำถามจากฟอร์ม =======
            const container = document.getElementById('allFormFields');
            container.innerHTML = '';

            const hiddenKeys = ['Timestamp', 'Time', 'No.', 'RequesterSignatureUrl'];

            const formKeys = Object.keys(form || {});
            if (formKeys.length > 0) {
              formKeys.forEach(key => {
                if (hiddenKeys.indexOf(key) !== -1) return;
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                rowDiv.innerHTML = `
                  <div class="row-label">${key}</div>
                  <div class="row-value">${form[key] !== undefined && form[key] !== '' ? form[key] : '-'}</div>
                `;
                container.appendChild(rowDiv);
              });
              document.getElementById('allFormCard').style.display = 'block';
            }

            document.getElementById('subtitle').textContent =
              'โปรดตรวจสอบรายละเอียดด้านล่าง และกดอนุมัติ / ไม่อนุมัติ';
          }
        );
      }

      // ---------- เช็คผลจากระบบหลักหลังส่ง POST ----------
      function checkApproveResult(expectedAction) {
        setStatus('ระบบกำลังตรวจสอบผลการบันทึกจากระบบหลัก...', 'info');

        jsonpRequest(
          'getWorkflowRequest',
          { requestNo: requestNo, session: sessionId },
          function(res2) {
            console.log('checkApproveResult:', res2);

            const btn = document.getElementById('submitBtn');
            let ok = false;

            if (res2 && res2.success && res2.data) {
              const d = res2.data;
              const stRaw = (d.status || '').toString().toLowerCase();
              const isApproved = stRaw.includes('approved');
              const isRejected = stRaw.includes('rejected');

              if ((expectedAction === 'Approved' && isApproved) ||
                  (expectedAction === 'Rejected' && isRejected)) {
                setStatus('บันทึกผลการอนุมัติเรียบร้อยแล้ว (ยืนยันจากระบบหลัก)', 'success');
                ok = true;
              }
            }

            if (!ok) {
              setStatus(
                '⚠️ ระบบไม่สามารถยืนยันผลการบันทึกได้ในขณะนี้ ' +
                'กรุณาตรวจสอบในระบบภายหลัง หรือแจ้ง HR/IT เพื่อช่วยตรวจสอบ',
                'error'
              );
              btn.disabled = false;
            }
          }
        );
      }

      // ---------- submit approve (ใช้ POST + no-cors แทน JSONP) ----------
      async function submitApprove() {
        if (!hasSignature) {
          setStatus('กรุณาวาดลายเซ็นก่อนบันทึก', 'error');
          canvas.scrollIntoView({behavior: 'smooth', block: 'center'});
          return;
        }

        const actionEl = document.querySelector('input[name="approveAction"]:checked');
        const action = actionEl ? actionEl.value : 'Approved';
        const comment = document.getElementById('comment').value || '';

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        setStatus('กำลังส่งข้อมูลไปยังระบบหลัก...', 'info');

        // ลดขนาด signature ให้เล็กลง (JPEG คุณภาพ 0.4)
        const dataUrl = canvas.toDataURL('image/jpeg', 0.4);
        const base64  = dataUrl.split(',')[1] || dataUrl;

        console.log('signature dataUrl length =', dataUrl.length);
        console.log('signature base64 length  =', base64.length);

        const payload = {
          action:        'saveApproveAction',
          requestNo:     requestNo,
          session:       sessionId,
          approveAction: action,
          signature:     base64,
          comment:       comment
        };

        try {
          await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(payload)
          });

          setStatus('ส่งข้อมูลเรียบร้อย กำลังตรวจสอบผลการบันทึกจากระบบหลัก...', 'info');

          setTimeout(function() {
            checkApproveResult(action);
          }, 4000);

        } catch (err) {
          console.error('fetch saveApproveAction error:', err);
          setStatus('⚠️ ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้ กรุณาลองใหม่อีกครั้ง', 'error');
          btn.disabled = false;
        }
      }

      // ---------- init ----------
      window.addEventListener('DOMContentLoaded', function() {
        console.log('Approve page (external) DOMContentLoaded');
        initCanvas();
        document.getElementById('clearSignBtn').addEventListener('click', clearSignature);
        document.getElementById('submitBtn').addEventListener('click', submitApprove);

        const params = new URLSearchParams(window.location.search);
        requestNo = params.get('requestNo') || '';
        sessionId = params.get('session')   || '';

        console.log('query requestNo:', requestNo, 'session:', sessionId);

        if (!requestNo || !sessionId) {
          document.getElementById('subtitle').textContent =
            'ลิงก์ไม่ถูกต้อง (ขาด requestNo หรือ session)';
          return;
        }
        loadRequest();
      });
    </script>
  </body>
</html>
