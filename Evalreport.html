<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 1000px;
      width: 100%;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }

    .company-name {
      color: #2c3e50;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.6;
    }

    h1 {
      color: #2c3e50;
      font-size: 28px;
      margin-top: 12px;
      font-weight: 700;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 14px;
      margin-top: 8px;
    }

    .info-section {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      border-left: 5px solid #667eea;
    }

    .info-row {
      display: flex;
      margin-bottom: 15px;
      align-items: center;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-weight: 600;
      color: #34495e;
      min-width: 200px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-value {
      color: #2c3e50;
      flex: 1;
      font-weight: 500;
      font-size: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin-bottom: 20px;
      padding: 15px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title span:first-child {
      font-size: 24px;
    }

    .eval-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      font-size: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .eval-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .eval-table th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    .eval-table th:last-child {
      text-align: center;
      width: 120px;
    }

    .eval-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
    }

    .eval-table td:last-child {
      text-align: center;
      font-weight: 700;
      font-size: 18px;
      color: #667eea;
    }

    .eval-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .eval-table tbody tr:hover {
      background-color: #e9ecef;
    }

    .score-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }

    .avg-score {
      text-align: right;
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-radius: 10px;
      border-left: 5px solid #27ae60;
    }

    .avg-score-label {
      color: #2c3e50;
      font-weight: 600;
      font-size: 16px;
    }

    .avg-score-value {
      font-size: 28px;
      color: #27ae60;
      font-weight: 700;
      margin-top: 5px;
    }

    .comments-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .comments-title {
      font-weight: 700;
      color: #856404;
      margin-bottom: 12px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comments-content {
      color: #856404;
      line-height: 1.7;
      white-space: pre-wrap;
      font-size: 15px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 15px;
    }

    .required {
      color: #e74c3c;
      margin-left: 3px;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
      background: white;
      font-family: inherit;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    input[readonly] {
      background-color: #f8f9fa;
      color: #6c757d;
    }

    .canvas-wrapper {
      position: relative;
      margin-top: 12px;
    }

    #signatureCanvas {
      border: 2px dashed #667eea;
      border-radius: 10px;
      cursor: crosshair;
      touch-action: none;
      display: block;
      width: 100%;
      max-width: 100%;
      height: 200px;
      background: #fafafa;
      transition: all 0.3s;
    }

    #signatureCanvas:hover {
      background: white;
      border-color: #764ba2;
    }

    #signatureCanvas.drawing {
      border-style: solid;
      background: white;
    }

    .canvas-hint {
      text-align: center;
      color: #95a5a6;
      font-size: 13px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 16px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-clear {
      background: #95a5a6;
      color: white;
    }

    .btn-clear:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
    }

    .btn-submit {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
    }

    .btn-submit:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    #status {
      margin-top: 25px;
      padding: 18px 20px;
      border-radius: 10px;
      display: none;
      animation: fadeIn 0.3s;
      border-left: 5px solid;
      font-weight: 500;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .success {
      background: #d4edda;
      color: #155724;
      border-color: #28a745;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border-color: #dc3545;
    }

    .loading {
      background: #fff3cd;
      color: #856404;
      border-color: #ffc107;
    }

    .pdf-link {
      display: inline-block;
      margin-top: 12px;
      padding: 12px 24px;
      background: #3498db;
      color: white !important;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .pdf-link:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(0,0,0,.2);
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      h1 {
        font-size: 22px;
      }

      .info-label {
        min-width: 140px;
        font-size: 14px;
      }

      .button-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }

      #signatureCanvas {
        height: 150px;
      }

      .eval-table {
        font-size: 13px;
      }

      .eval-table th,
      .eval-table td {
        padding: 8px;
      }

      .avg-score-value {
        font-size: 24px;
      }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="company-name">
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Ñ‡∏≤‡∏£‡πå‡πÄ‡∏õ‡∏ó ‡πÄ‡∏°‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå(‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢) ‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞<br>
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Ñ‡∏≤‡∏£‡πå‡πÄ‡∏õ‡∏ó ‡πÄ‡∏°‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏û‡∏µ2‡∏î‡∏±‡∏ö‡∏ö‡∏•‡∏¥‡∏ß (‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢) ‡∏à‡∏≥‡∏Å‡∏±‡∏î
      </div>
      <h1>üìã ‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h1>
      <div class="subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
    </div>

    <!-- Loading State -->
    <div id="loading" style="text-align: center; padding: 40px;">
      <div class="loading-spinner" style="justify-content: center; margin-bottom: 15px;">
        <div class="spinner"></div>
        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
      </div>
    </div>

    <!-- Main Content (hidden until data loads) -->
    <div id="mainContent" style="display: none;">
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ -->
      <div class="info-section">
        <div class="info-row">
          <div class="info-label">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£:</div>
          <div class="info-value" id="applicantName">-</div>
        </div>
        <div class="info-row">
          <div class="info-label">üíº ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£:</div>
          <div class="info-value" id="applicantPosition">-</div>
        </div>
        <div class="info-row">
          <div class="info-label">üè¢ ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</div>
          <div class="info-value" id="applicantSection">-</div>
        </div>
        <div class="info-row">
          <div class="info-label">üìÇ ‡πÅ‡∏ú‡∏ô‡∏Å:</div>
          <div class="info-value" id="applicantDept">-</div>
        </div>
      </div>

      <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô -->
      <div>
        <div class="section-title">
          <span>üìä</span>
          <span>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (10 ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)</span>
        </div>
        <table class="eval-table">
          <thead>
            <tr>
              <th style="width: 50px;">‡∏ó‡∏µ‡πà</th>
              <th>‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
            </tr>
          </thead>
          <tbody id="scoresTable">
            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
          </tbody>
        </table>

        <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ -->
        <div class="avg-score">
          <div class="avg-score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</div>
          <div class="avg-score-value" id="averageScore">-</div>
        </div>
      </div>

      <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
      <div id="commentsSection">
        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
      </div>

      <!-- ‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
      <div>
        <div class="section-title">
          <span>‚úçÔ∏è</span>
          <span>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>
        </div>

        <div class="form-group">
          <label>
            ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            <span class="required">*</span>
          </label>
          <div class="canvas-wrapper">
            <canvas id="signatureCanvas" width="800" height="200"></canvas>
            <div class="canvas-hint">
              <span>‚úçÔ∏è</span>
              <span>‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏¥‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-clear" onclick="clearSignature()">
            <span>üóëÔ∏è</span>
            <span>‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
          </button>
          <button class="btn-submit" id="submitBtn" onclick="submitSignature()">
            <span>‚úÖ</span>
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á PDF</span>
          </button>
        </div>
      </div>

      <!-- Status Message -->
      <div id="status"></div>
    </div>
  </div>

  <script>
    // ========== CONFIG ==========
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwAL1ISDOIC_0TVh4RZniHn34vP0O7x5yBHlyxGZ1-u8ctgEg9OtG9dNMAZwxH7sNww/exec';
    
    // ‡∏î‡∏∂‡∏á URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const rowIndex = urlParams.get('row') || '';
    const sessionId = urlParams.get('session') || '';

    // ========== CANVAS SETUP ==========
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let hasDrawn = false;

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ canvas
    ctx.strokeStyle = '#2c3e50';
    ctx.lineWidth = 2.5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // ========== CANVAS EVENTS (Mouse) ==========
    canvas.addEventListener('mousedown', (e) => {
      isDrawing = true;
      canvas.classList.add('drawing');
      const rect = canvas.getBoundingClientRect();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      hasDrawn = true;
    });

    canvas.addEventListener('mouseup', () => {
      isDrawing = false;
      canvas.classList.remove('drawing');
    });

    canvas.addEventListener('mouseout', () => {
      isDrawing = false;
      canvas.classList.remove('drawing');
    });

    // ========== CANVAS EVENTS (Touch) ==========
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      isDrawing = true;
      canvas.classList.add('drawing');
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      ctx.beginPath();
      ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    });

    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!isDrawing) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      ctx.stroke();
      hasDrawn = true;
    });

    canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      isDrawing = false;
      canvas.classList.remove('drawing');
    });

    // ========== FUNCTIONS ==========

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasDrawn = false;
      hideStatus();
    }

    function showStatus(type, message) {
      const status = document.getElementById('status');
      status.className = type;
      status.innerHTML = message;
      status.style.display = 'block';
      status.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    // ========== LOAD DATA ==========

    function loadEvaluationData() {
      if (!rowIndex) {
        showStatus('error', '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß (row parameter)');
        return;
      }

      const url = APPS_SCRIPT_URL + 
        '?action=getEvaluationData' +
        '&row=' + encodeURIComponent(rowIndex) +
        '&callback=handleEvalDataResponse';

      // JSONP request
      const script = document.createElement('script');
      script.src = url;
      script.onerror = () => {
        showStatus('error', '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
      };
      document.head.appendChild(script);
    }

    // JSONP Callback
    window.handleEvalDataResponse = function(response) {
      console.log('üìä Data response:', response);

      if (!response || !response.success) {
        showStatus('error', '‚ùå ' + (response?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'));
        return;
      }

      const data = response.data;

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
      document.getElementById('applicantName').textContent = data.applicantName || '-';
      document.getElementById('applicantPosition').textContent = data.applicantPosition || '-';
      document.getElementById('applicantSection').textContent = data.applicantSection || '-';
      document.getElementById('applicantDept').textContent = data.applicantDept || '-';

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      displayScores(data.scores);

      // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
      document.getElementById('averageScore').textContent = data.averageScore + ' / 10';

      // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
      displayComments(data.comments);

      // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏™‡∏î‡∏á content
      document.getElementById('loading').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    };

    function displayScores(scores) {
      const tbody = document.getElementById('scoresTable');
      tbody.innerHTML = '';

      if (!scores || !Array.isArray(scores)) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#e74c3c;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</td></tr>';
        return;
      }

      scores.forEach((score, idx) => {
        const row = document.createElement('tr');
        const scoreNum = parseInt(score.value);
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        let badgeColor = '#27ae60';
        if (scoreNum >= 9) badgeColor = '#27ae60'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        else if (scoreNum >= 8) badgeColor = '#3498db'; // ‡∏ü‡πâ‡∏≤
        else if (scoreNum >= 7) badgeColor = '#f39c12'; // ‡∏™‡πâ‡∏°
        else if (scoreNum >= 1) badgeColor = '#e74c3c'; // ‡πÅ‡∏î‡∏á
        
        row.innerHTML = `
          <td style="text-align:center;font-weight:700;">${idx + 1}</td>
          <td>${score.factor}</td>
          <td><span class="score-badge" style="background: linear-gradient(135deg, ${badgeColor} 0%, ${badgeColor}cc 100%);">${score.value}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function displayComments(comments) {
      const section = document.getElementById('commentsSection');
      section.innerHTML = '';

      if (!comments || String(comments).trim() === '-') {
        return; // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô
      }

      const html = `
        <div class="comments-box">
          <div class="comments-title">
            <span>üí¨</span>
            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
          </div>
          <div class="comments-content">${String(comments).replace(/\n/g, '<br>')}</div>
        </div>
      `;

      section.innerHTML = html;
    }

    function submitSignature() {
      const submitBtn = document.getElementById('submitBtn');

      // Validation
      if (!hasDrawn) {
        showStatus('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      if (!rowIndex) {
        showStatus('error', '‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }

      // Get signature
      const signatureBase64 = canvas.toDataURL('image/png');

      // Disable button
      submitBtn.disabled = true;
      showStatus('loading', 
        '<div class="loading-spinner">' +
        '<div class="spinner"></div>' +
        '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...</span>' +
        '</div>'
      );

      // ‡∏™‡πà‡∏á POST request
      const payload = {
  action: 'saveEvalSignature',
  rowIndex: rowIndex,
  sessionId: sessionId,
  evaluatorName: document.getElementById('applicantName').textContent,
  evaluatorPosition: document.getElementById('applicantPosition').textContent,
  signature: signatureBase64
};

fetch(APPS_SCRIPT_URL, {
  method: 'POST',
  // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà headers: { 'Content-Type': 'application/json' },
  // browser ‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô text/plain ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô preflight
  body: JSON.stringify(payload)
})
  .then(response => response.json())
  .then(result => {
    console.log('‚úÖ Response:', result);

    if (result.success) {
      showStatus(
        'success',
        '‚úÖ <strong>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</strong><br><br>' +
          '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß<br><br>' +
          (result.pdfUrl
            ? '<a href="' +
              result.pdfUrl +
              '" target="_blank" class="pdf-link">üìÑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π PDF</a>'
            : '')
      );
      document.querySelector('.button-group').style.display = 'none';
    } else {
      showStatus('error', '‚ùå ' + (result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
      submitBtn.disabled = false;
    }
  })
  .catch(error => {
    console.error('‚ùå Error:', error);
    showStatus('error', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
    submitBtn.disabled = false;
  });

    }

    // ========== INIT ==========
    window.addEventListener('load', () => {
      console.log('üé® Evalreport.html loaded');
      console.log('Row:', rowIndex, 'Session:', sessionId);
      
      if (!rowIndex) {
        document.getElementById('loading').innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (missing row parameter)';
        return;
      }

      loadEvaluationData();
    });
  </script>
</body>
</html>